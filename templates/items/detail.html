{% extends 'base.html' %}

{% block title %}{{ item.category }} - UniFind{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div style="max-width: 900px; margin: 0 auto;">
            <!-- Back Button -->
            <a href="javascript:history.back()" style="display: inline-flex; align-items: center; color: #08598b; text-decoration: none; margin-bottom: 1rem; font-size: 1.5rem;">
                <i class="fas fa-arrow-left"></i>
            </a>
            
            <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                    <!-- Image Section -->
                    <div>
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.category }}" style="width: 100%; height: 400px; object-fit: contain; background-color: #f5f5f5;">
                        {% else %}
                        <div style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #08598b 0%, #0a6fa8 100%); color: #ecb80d; font-size: 6rem;">
                            {% if item.category == 'ID' %}ü™™
                            {% elif item.category == 'Gadget' %}üì±
                            {% elif item.category == 'Book' %}üìö
                            {% elif item.category == 'Clothing' %}üëï
                            {% elif item.category == 'Keys' %}üîë
                            {% elif item.category == 'Wallet' %}üëõ
                            {% else %}üì¶{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Details Section -->
                    <div style="padding: 2rem;">
                        <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span class="card-badge {% if item.type == 'lost' %}badge-lost{% else %}badge-found{% endif %}" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                {{ item.get_type_display }}
                            </span>
                            <span class="card-badge" style="background-color: #f0f0f0; color: #666; font-size: 1rem; padding: 0.5rem 1rem;">{{ item.category }}</span>
                            <span class="card-badge" style="background-color: 
                                {% if item.severity == 'critical' %}#dc3545
                                {% elif item.severity == 'high' %}#fd7e14
                                {% elif item.severity == 'medium' %}#ffc107
                                {% else %}#6c757d{% endif %}; color: white; font-size: 1rem; padding: 0.5rem 1rem;">
                                {{ item.get_severity_display }}
                            </span>
                        </div>
                        
                        <h1 style="color: #08598b; margin-bottom: 1rem; font-size: 1.8rem;">{{ item.name|default:item.category }}</h1>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #08598b; font-size: 1rem; margin-bottom: 0.5rem;">Description</h3>
                            <p style="color: #333; line-height: 1.6;">{{ item.description }}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #08598b; font-size: 1rem; margin-bottom: 0.5rem;">Location</h3>
                            <p style="color: #666;">üìç {{ item.location_text }}</p>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #08598b; font-size: 1rem; margin-bottom: 0.5rem;">Posted</h3>
                            <p style="color: #666;">{{ item.created_at|date:"F d, Y" }} ({{ item.created_at|timesince }} ago)</p>
                        </div>
                        
                        {% if item.claim_proof %}
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #08598b; font-size: 1rem; margin-bottom: 0.5rem;">Proof of Return/Claim</h3>
                            <img src="{{ item.claim_proof.url }}" alt="Proof of claim" style="max-width: 100%; border-radius: 8px; border: 2px solid #28a745; cursor: pointer;" onclick="window.open('{{ item.claim_proof.url }}', '_blank')">
                            <p style="color: #28a745; font-size: 0.9rem; margin-top: 0.5rem;">‚úì This item has been returned/claimed (click image to view full size)</p>
                            {% if item.claimed_by_username %}
                            <p style="color: #08598b; font-size: 0.95rem; margin-top: 0.5rem;">
                                <strong>Returned/Claimed by:</strong> @{{ item.claimed_by_username }}
                            </p>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if not item.is_anonymous %}
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #08598b; font-size: 1rem; margin-bottom: 0.5rem;">Posted By</h3>
                            <p style="color: #666;">{{ item.user.get_full_name|default:item.user.username }} ({{ item.user.reputation_points }} pts)</p>
                        </div>
                        {% else %}
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="color: #08598b; font-size: 1rem; margin-bottom: 0.5rem;">Posted By</h3>
                            <p style="color: #666;">Anonymous</p>
                        </div>
                        {% endif %}
                        
                        {% if user.is_authenticated and user == item.user %}
                        <!-- Owner's actions -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <a href="{% url 'items:edit_item' item.id %}" class="btn btn-secondary" style="flex: 1;">Edit</a>
                            <form method="post" action="{% url 'items:delete_item' item.id %}" style="flex: 1;" onsubmit="return confirm('Are you sure you want to delete this item?');">
                                {% csrf_token %}
                                <button type="submit" class="btn" style="width: 100%; background-color: #dc3545; color: white; border: none;">Delete</button>
                            </form>
                        </div>
                        {% elif user.is_authenticated and user.is_staff %}
                        <!-- Admin actions -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            {% if item.status == 'approved' and item.status != 'claimed' %}
                            <form method="post" action="{% url 'items:mark_as_claimed' item.id %}" style="flex: 1;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary" style="width: 100%;" onclick="return confirm('Mark this item as claimed?');">Mark as Claimed</button>
                            </form>
                            {% endif %}
                            <a href="{% url 'messaging:send_message' item.id %}" class="btn btn-secondary" style="flex: 1;">Message</a>
                        </div>
                        {% elif user.is_authenticated %}
                        <!-- Other user's actions -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            {% if item.type == 'found' %}
                            <a href="{% url 'claims:claim_item' item.id %}" class="btn btn-primary" style="flex: 1;">Claim This Item</a>
                            {% endif %}
                            <a href="{% url 'messaging:send_message' item.id %}" class="btn btn-secondary" style="flex: 1;">Message</a>
                        </div>
                        {% elif not user.is_authenticated %}
                        <a href="{% url 'users:login' %}" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Login to Contact</a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Map Section -->
                {% if item.location_lat and item.location_lng %}
                <div style="padding: 2rem; border-top: 1px solid #ddd;">
                    <h3 style="color: #08598b; margin-bottom: 1rem;">Location on Map</h3>
                    <div id="map" style="height: 300px; border-radius: 5px;"></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
{% if item.location_lat and item.location_lng %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([{{ item.location_lat }}, {{ item.location_lng }}], 16);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    L.marker([{{ item.location_lat }}, {{ item.location_lng }}])
        .addTo(map)
        .bindPopup('{{ item.location_text }}')
        .openPopup();
</script>
{% endif %}
{% endblock %}
