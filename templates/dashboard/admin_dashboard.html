{% extends 'base.html' %}

{% block title %}Admin Dashboard - UniFind{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <h1 style="color: #08598b; margin-bottom: 2rem;">Admin Dashboard</h1>
        
        <!-- Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: linear-gradient(135deg, #ecb80d 0%, #d4a50c 100%); padding: 1.5rem; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 2rem; font-weight: bold;">{{ pending_count }}</div>
                <div>Pending Approval</div>
            </div>
            <div style="background: linear-gradient(135deg, #28a745 0%, #20873a 100%); padding: 1.5rem; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 2rem; font-weight: bold;">{{ approved_count }}</div>
                <div>Approved Items</div>
            </div>
            <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 1.5rem; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 2rem; font-weight: bold;">{{ rejected_count }}</div>
                <div>Rejected Items</div>
            </div>
            <div style="background: linear-gradient(135deg, #08598b 0%, #0a6fa8 100%); padding: 1.5rem; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <div style="font-size: 2rem; font-weight: bold;">{{ recent_matches|length }}</div>
                <div>Pending Matches</div>
            </div>
        </div>

        <!-- Lost Items Trend Chart -->
        <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <h2 style="color: #08598b; margin-bottom: 1.5rem;">
                <i class="fas fa-chart-line" style="color: #ecb80d;"></i> Lost Items Trend (Last 7 Days)
            </h2>
            <canvas id="lostItemsChart" style="max-height: 400px;"></canvas>
        </div>

        <!-- Pending Items -->
        <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem;">
            <h2 style="color: #08598b; margin-bottom: 1.5rem;">Pending Items for Approval</h2>
            
            {% if pending_items %}
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for item in pending_items %}
                <div style="border: 2px solid #ecb80d; padding: 1.5rem; border-radius: 8px; display: flex; gap: 1rem;">
                    {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.category }}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;">
                    {% else %}
                    <div style="width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; border-radius: 5px; font-size: 2rem;">üì¶</div>
                    {% endif %}
                    
                    <div style="flex: 1;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <span class="card-badge {% if item.type == 'lost' %}badge-lost{% else %}badge-found{% endif %}">{{ item.get_type_display }}</span>
                            <span class="card-badge" style="background-color: #f0f0f0; color: #666;">{{ item.category }}</span>
                            <span class="card-badge" style="background-color: 
                                {% if item.severity == 'critical' %}#dc3545
                                {% elif item.severity == 'high' %}#fd7e14
                                {% elif item.severity == 'medium' %}#ffc107
                                {% else %}#6c757d{% endif %}; color: white;">
                                {{ item.get_severity_display }}
                            </span>
                        </div>
                        <h3 style="color: #08598b; margin-bottom: 0.5rem;">{{ item.name|default:item.description|truncatewords:10 }}</h3>
                        <p style="color: #666; margin-bottom: 0.5rem;">{{ item.description|truncatewords:20 }}</p>
                        <p style="color: #999; font-size: 0.9rem;">üìç {{ item.location_text }} ‚Ä¢ Posted by: <strong>{{ item.user.get_full_name|default:item.user.username }}</strong> ‚Ä¢ {{ item.created_at|timesince }} ago</p>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; justify-content: center;">
                        <form method="post" action="{% url 'dashboard:approve_item' item.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn" style="background-color: #28a745; color: white; padding: 0.5rem 1rem; font-size: 0.9rem; width: 100%;">‚úì Approve</button>
                        </form>
                        <button onclick="showRejectModal({{ item.id }}, '{{ item.name|default:item.description|truncatewords:5|escapejs }}')" class="btn" style="background-color: #dc3545; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;">‚úó Reject</button>
                        <a href="{% url 'items:detail' item.id %}" class="btn" style="background-color: #6c757d; color: white; padding: 0.5rem 1rem; font-size: 0.9rem; text-align: center;">View</a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="text-align: center; color: #999; padding: 2rem;">No pending items</p>
            {% endif %}
        </div>

        <!-- Potential Matches -->
        <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="color: #08598b; margin-bottom: 1.5rem;">Potential Matches (Not Yet Notified)</h2>
            
            {% if recent_matches %}
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for match in recent_matches %}
                <div style="border: 2px solid #28a745; padding: 1.5rem; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #28a745; margin: 0;">{{ match.match_percentage }}% Match</h3>
                        <form method="post" action="{% url 'dashboard:notify_match' match.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Notify Users</button>
                        </form>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: center;">
                        <!-- Lost Item -->
                        <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 5px;">
                            <span class="card-badge badge-lost" style="margin-bottom: 0.5rem;">Lost</span>
                            <h4 style="color: #08598b; margin: 0.5rem 0;">{{ match.lost_item.name|default:match.lost_item.description|truncatewords:8 }}</h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">{{ match.lost_item.category }}</p>
                            <p style="color: #999; font-size: 0.85rem; margin-top: 0.5rem;">By: {{ match.lost_item.user.username }}</p>
                        </div>
                        
                        <div style="font-size: 2rem; color: #28a745;">‚ÜîÔ∏è</div>
                        
                        <!-- Found Item -->
                        <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 5px;">
                            <span class="card-badge badge-found" style="margin-bottom: 0.5rem;">Found</span>
                            <h4 style="color: #08598b; margin: 0.5rem 0;">{{ match.found_item.name|default:match.found_item.description|truncatewords:8 }}</h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">{{ match.found_item.category }}</p>
                            <p style="color: #999; font-size: 0.85rem; margin-top: 0.5rem;">By: {{ match.found_item.user.username }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="text-align: center; color: #999; padding: 2rem;">No pending matches</p>
            {% endif %}
        </div>
    </div>
</section>

<!-- Reject Modal -->
<div id="rejectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 style="color: #08598b; margin-bottom: 1rem;">Reject Item</h3>
        <p id="rejectItemName" style="color: #666; margin-bottom: 1rem;"></p>
        <form id="rejectForm" method="post">
            {% csrf_token %}
            <div class="form-group">
                <label>Reason for Rejection:</label>
                <textarea name="reason" rows="4" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;" required></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button type="submit" class="btn" style="background-color: #dc3545; color: white; flex: 1;">Reject</button>
                <button type="button" onclick="closeRejectModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function showRejectModal(itemId, itemName) {
    document.getElementById('rejectModal').style.display = 'flex';
    document.getElementById('rejectItemName').textContent = 'Item: ' + itemName;
    document.getElementById('rejectForm').action = '/admin/reject/' + itemId + '/';
}

function closeRejectModal() {
    document.getElementById('rejectModal').style.display = 'none';
}

// Lost Items Trend Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('lostItemsChart').getContext('2d');
    
    const dates = {{ chart_dates|safe }};
    const categories = {{ chart_categories|safe }};
    const chartData = {{ chart_data|safe }};
    
    // Define colors for each category
    const categoryColors = {
        'ID': '#dc3545',
        'Gadget': '#007bff',
        'Clothing': '#28a745',
        'Accessories': '#ffc107',
        'Book': '#17a2b8',
        'Books': '#17a2b8',
        'Keys': '#6f42c1',
        'Wallet': '#fd7e14',
        'Others': '#6c757d'
    };
    
    // Prepare datasets - include all categories with their colors
    const datasets = categories.map(category => {
        // Get color for category, use default if not found
        const color = categoryColors[category] || categoryColors['Others'] || '#6c757d';
        return {
            label: category,
            data: chartData[category] || [0, 0, 0, 0, 0, 0, 0], // Default to zeros if no data
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: color,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        };
    });
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12,
                            family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                        },
                        generateLabels: function(chart) {
                            // Show all categories in legend with their colors
                            const categories = {{ chart_categories|safe }};
                            const categoryColors = {
                                'ID': '#dc3545',
                                'Gadget': '#007bff',
                                'Clothing': '#28a745',
                                'Accessories': '#ffc107',
                                'Book': '#17a2b8',
                                'Books': '#17a2b8',
                                'Keys': '#6f42c1',
                                'Wallet': '#fd7e14',
                                'Others': '#6c757d'
                            };
                            
                            return categories.map((category, index) => {
                                const dataset = chart.data.datasets[index];
                                const color = categoryColors[category] || categoryColors['Others'] || '#6c757d';
                                return {
                                    text: category,
                                    fillStyle: color,
                                    strokeStyle: color,
                                    lineWidth: 3,
                                    hidden: false,
                                    index: index
                                };
                            });
                        }
                    }
                },
                title: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: {
                        size: 14
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    title: {
                        display: true,
                        text: 'Number of Lost Items',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        color: '#08598b'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            size: 13,
                            weight: 'bold'
                        },
                        color: '#08598b'
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
});
</script>
{% endblock %}
