{% extends 'base.html' %}

{% block extra_css %}
<style>
@media (max-width: 768px) {
    .section {
        padding: 1rem 0;
    }
    
    .container {
        padding: 0 0.5rem;
    }
    
    /* Mobile message adjustments */
    .message-container {
        padding: 0.5rem !important;
    }
    
    .message-bubble {
        max-width: 90% !important;
        padding: 0.5rem !important;
        font-size: 0.9rem;
    }
    
    .user-header {
        padding: 0.75rem !important;
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
    
    .message-form {
        flex-direction: column !important;
        gap: 0.5rem !important;
    }
    
    .message-input {
        width: 100% !important;
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}

{% block title %}Conversation with {{ other_user.username }} - UniFind{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <div style="max-width: 900px; margin: 0 auto; padding: 0 1rem;">
            
            <!-- User Header -->
            <div style="background: white; padding: 1rem; border-radius: 8px 8px 0 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center;">
                {% if not other_user %}
                    <!-- No Admin Available -->
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #08598b 0%, #0a6fa8 100%); display: flex; align-items: center; justify-content: center; color: #ecb80d; font-size: 1.5rem; border: 2px solid #08598b; margin-right: 1rem;">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div>
                        <h2 style="color: #08598b; margin: 0; font-size: 1.3rem;">Admin</h2>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">No administrator available</p>
                    </div>
                {% elif other_user.is_staff %}
                    <!-- Admin Icon (for regular users viewing admin) -->
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #08598b 0%, #0a6fa8 100%); display: flex; align-items: center; justify-content: center; color: #ecb80d; font-size: 1.5rem; border: 2px solid #08598b; margin-right: 1rem;">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div>
                        <h2 style="color: #08598b; margin: 0; font-size: 1.3rem;">Admin</h2>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">System Administrator</p>
                    </div>
                {% else %}
                    <!-- User Profile Picture (for admin viewing users) -->
                    {% if other_user.profile_picture %}
                    <img src="{{ other_user.profile_picture.url }}" alt="{{ other_user.username }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #08598b; margin-right: 1rem;">
                    {% else %}
                    <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #08598b 0%, #0a6fa8 100%); display: flex; align-items: center; justify-content: center; color: #ecb80d; font-size: 1.5rem; border: 2px solid #08598b; margin-right: 1rem;">
                        <i class="fas fa-user"></i>
                    </div>
                    {% endif %}
                    <div>
                        <h2 style="color: #08598b; margin: 0; font-size: 1.3rem;">{{ other_user.get_full_name|default:other_user.username }}</h2>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">@{{ other_user.username }}</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Messages Container -->
            <div style="background: #f5f5f5; padding: 1rem; min-height: 400px; max-height: 500px; overflow-y: auto; border-left: 1px solid #ddd; border-right: 1px solid #ddd;">
                {% for message in messages %}
                    <!-- Message Bubble -->
                    <div style="margin-bottom: 1rem; display: flex; {% if message.sender == user %}justify-content: flex-end;{% else %}justify-content: flex-start;{% endif %}">
                        <div style="max-width: 85%; {% if message.sender == user %}background: #08598b; color: white;{% else %}background: white; color: #333;{% endif %} padding: 0.75rem; border-radius: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            {% if message.item %}
                            <!-- Item Preview (messenger reply style) -->
                            <a href="{% url 'items:detail' message.item.id %}" style="display: block; margin-bottom: 0.75rem; text-decoration: none; {% if message.sender == user %}color: white;{% else %}color: inherit;{% endif %}">
                                <div style="display: flex; align-items: center; background: {% if message.sender == user %}rgba(255,255,255,0.2){% else %}#f5f5f5{% endif %}; border-left: 3px solid {% if message.sender == user %}#ecb80d{% else %}#08598b{% endif %}; border-radius: 5px; padding: 0.5rem; cursor: pointer;">
                                    {% if message.item.image %}
                                    <img src="{{ message.item.image.url }}" alt="{{ message.item.name|default:message.item.category }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; margin-right: 0.75rem;">
                                    {% else %}
                                    <div style="width: 50px; height: 50px; background: {% if message.sender == user %}rgba(255,255,255,0.3){% else %}linear-gradient(135deg, #08598b 0%, #0a6fa8 100%){% endif %}; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: {% if message.sender == user %}#ecb80d{% else %}#ecb80d{% endif %}; font-size: 1.5rem; margin-right: 0.75rem;">
                                        {% if message.item.category == 'ID' %}ðŸªª
                                        {% elif message.item.category == 'Gadget' %}ðŸ“±
                                        {% elif message.item.category == 'Book' %}ðŸ“š
                                        {% elif message.item.category == 'Clothing' %}ðŸ‘•
                                        {% elif message.item.category == 'Keys' %}ðŸ”‘
                                        {% elif message.item.category == 'Wallet' %}ðŸ‘›
                                        {% else %}ðŸ“¦{% endif %}
                                    </div>
                                    {% endif %}
                                    <div style="flex: 1;">
                                        <p style="margin: 0; font-size: 0.85rem; font-weight: 600; {% if message.sender == user %}color: white;{% else %}color: #08598b;{% endif %}">{{ message.item.name|default:message.item.category }}</p>
                                        <p style="margin: 0; font-size: 0.75rem; {% if message.sender == user %}color: rgba(255,255,255,0.8);{% else %}color: #999;{% endif %}">{{ message.item.get_type_display }}</p>
                                    </div>
                                </div>
                            </a>
                            {% endif %}
                            {% if message.image %}
                            <div style="margin-bottom: 0.5rem;">
                                <img src="{{ message.image.url }}" alt="Message image" style="max-width: 100%; max-height: 300px; border-radius: 8px; object-fit: contain;">
                            </div>
                            {% endif %}
                            {% if message.content %}
                            <p style="margin: 0; word-wrap: break-word;">{{ message.content }}</p>
                            {% endif %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                <span style="font-size: 0.75rem; {% if message.sender == user %}color: #ecb80d;{% else %}color: #999;{% endif %}">
                                    {{ message.created_at|date:"M d, g:i A" }}
                                </span>
                                {% if message.sender == user %}
                                <span style="font-size: 0.75rem; color: #ecb80d; margin-left: 0.5rem;">
                                    {% if message.is_read %}âœ“âœ“{% else %}âœ“{% endif %}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Message Input -->
            {% if other_user %}
            <div style="background: white; padding: 1rem; border-radius: 0 0 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <!-- Image Preview Container -->
                <div id="imagePreviewContainer" style="display: none; margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <!-- Images will be dynamically added here -->
                </div>
                
                <form method="post" enctype="multipart/form-data" id="messageForm" style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
                    {% csrf_token %}
                    <textarea name="content" id="messageContent" placeholder="Type your message..." style="flex: 1; padding: 0.8rem; border: 1px solid #ddd; border-radius: 20px; resize: none; font-family: inherit; font-size: 1rem;" rows="2"></textarea>
                    <label for="messageImage" style="display: inline-flex; align-items: center; justify-content: center; width: 45px; height: 45px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 50%; cursor: pointer; transition: all 0.3s; margin-right: 0.5rem;" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">
                        <i class="fas fa-paperclip" style="color: #08598b; font-size: 1.2rem;"></i>
                        <input type="file" id="messageImage" name="image" accept="image/*" style="display: none;" onchange="previewImage(this);" multiple>
                    </label>
                    <button type="submit" class="btn btn-primary" style="align-self: flex-end; padding: 0.8rem 2rem;">Send</button>
                </form>
                <script>
                    let selectedImages = [];
                    
                    function previewImage(input) {
                        const previewContainer = document.getElementById('imagePreviewContainer');
                        const files = input.files;
                        
                        if (files && files.length > 0) {
                            // Add new files to selectedImages array
                            for (let i = 0; i < files.length; i++) {
                                const file = files[i];
                                const reader = new FileReader();
                                
                                reader.onload = function(e) {
                                    const imageData = {
                                        id: Date.now() + i,
                                        src: e.target.result,
                                        file: file
                                    };
                                    selectedImages.push(imageData);
                                    displayImages();
                                };
                                
                                reader.readAsDataURL(file);
                            }
                        }
                    }
                    
                    function displayImages() {
                        const previewContainer = document.getElementById('imagePreviewContainer');
                        previewContainer.innerHTML = '';
                        
                        if (selectedImages.length === 0) {
                            previewContainer.style.display = 'none';
                            return;
                        }
                        
                        previewContainer.style.display = 'flex';
                        
                        selectedImages.forEach((imageData, index) => {
                            const imageWrapper = document.createElement('div');
                            imageWrapper.style.position = 'relative';
                            imageWrapper.style.width = '80px';
                            imageWrapper.style.height = '80px';
                            imageWrapper.style.flexShrink = '0';
                            
                            const img = document.createElement('img');
                            img.src = imageData.src;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            img.style.borderRadius = '8px';
                            img.style.border = '2px solid #ddd';
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.type = 'button';
                            removeBtn.onclick = function() { removeImage(imageData.id); };
                            removeBtn.style.position = 'absolute';
                            removeBtn.style.top = '-8px';
                            removeBtn.style.right = '-8px';
                            removeBtn.style.width = '24px';
                            removeBtn.style.height = '24px';
                            removeBtn.style.background = '#dc3545';
                            removeBtn.style.color = 'white';
                            removeBtn.style.border = 'none';
                            removeBtn.style.borderRadius = '50%';
                            removeBtn.style.cursor = 'pointer';
                            removeBtn.style.display = 'flex';
                            removeBtn.style.alignItems = 'center';
                            removeBtn.style.justifyContent = 'center';
                            removeBtn.style.fontSize = '0.8rem';
                            removeBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                            removeBtn.style.zIndex = '10';
                            removeBtn.onmouseover = function() { this.style.background = '#c82333'; };
                            removeBtn.onmouseout = function() { this.style.background = '#dc3545'; };
                            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                            
                            imageWrapper.appendChild(img);
                            imageWrapper.appendChild(removeBtn);
                            previewContainer.appendChild(imageWrapper);
                        });
                        
                        // Update the file input to reflect selected images
                        updateFileInput();
                    }
                    
                    function removeImage(imageId) {
                        selectedImages = selectedImages.filter(img => img.id !== imageId);
                        displayImages();
                    }
                    
                    function clearImage() {
                        selectedImages = [];
                        document.getElementById('messageImage').value = '';
                        displayImages();
                    }
                    
                    function updateFileInput() {
                        // Create a new DataTransfer object to update the file input
                        const dataTransfer = new DataTransfer();
                        selectedImages.forEach(imageData => {
                            dataTransfer.items.add(imageData.file);
                        });
                        document.getElementById('messageImage').files = dataTransfer.files;
                    }
                    
                    document.getElementById('messageForm').addEventListener('submit', function(e) {
                        const content = document.getElementById('messageContent').value.trim();
                        const imageCount = selectedImages.length;
                        
                        if (!content && imageCount === 0) {
                            e.preventDefault();
                            alert('Please enter a message or select an image.');
                            return;
                        }
                        
                        // Update file input with all selected images before submit
                        if (imageCount > 0) {
                            updateFileInput();
                        }
                    });
                </script>
            </div>
            {% else %}
            <div style="background: white; padding: 1.5rem; border-radius: 0 0 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; color: #999;">
                <p style="margin: 0;">No administrator available to message at this time.</p>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
// Auto-scroll to bottom of messages
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.querySelector('[style*="overflow-y: auto"]');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
});
</script>
{% endblock %}
